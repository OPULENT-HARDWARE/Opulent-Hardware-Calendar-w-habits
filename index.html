<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Opulent Hardware - Calendar v2 (Habit Squares)</title>
  <link href="https://fonts.googleapis.com/css2?family=Saira:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      /* DARK THEME — true black */
      --d-bg: #000000;
      --d-bg-2: #0a0a0a;
      --d-border: rgba(255,255,255,.10);
      --d-text: #f2f6ff;
      --d-muted: #9aa6b2;
      --d-accent: #b6ff3b; /* green */

      /* LIGHT THEME */
      --l-bg: #f5f7fb;
      --l-bg-2: #eef2f7;
      --l-border: rgba(0,0,0,.08);
      --l-text: #1b2733;
      --l-muted: #5a6a7a;
      --l-accent: #4aa9ff; /* blue */

      --radius: 20px;
      --shadow: 0 24px 60px rgba(0,0,0,.35), 0 8px 20px rgba(0,0,0,.35);
      --tile: 14px;

      /* habit grid metrics */
      --habit-gap: 4px;
      --habit-pad: 10px;     /* inner padding inside a day tile for the grid */
      --habit-top-reserve: 26px; /* reserve space for the date number */
    }

    html[data-theme="dark"] {
      --bg: var(--d-bg);
      --bg2: var(--d-bg-2);
      --border: var(--d-border);
      --text: var(--d-text);
      --muted: var(--d-muted);
      --accent: var(--d-accent);
    }
    html[data-theme="light"] {
      --bg: var(--l-bg);
      --bg2: var(--l-bg-2);
      --border: var(--l-border);
      --text: var(--l-text);
      --muted: var(--l-muted);
      --accent: var(--l-accent);
    }

    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: 'Saira', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Inter", "SF Pro", Arial, sans-serif;
      background:
        radial-gradient(1200px 700px at 60% -10%, rgba(255,255,255,.02) 0, transparent 55%),
        var(--bg);
      color: var(--text);
      display: grid; place-items: center;
    }

    .frame {
      width: min(1100px, 96vw);
      height: min(820px, 92vh);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      display: grid;
      grid-template-rows: auto 1fr;
      background: var(--bg);
      border: 1px solid var(--border);
    }

    /* Top wood branding */
    .top-wood {
      position: relative;
      background:
        linear-gradient(90deg, rgba(0,0,0,.06), rgba(0,0,0,0) 18%),
        repeating-linear-gradient(12deg,
          rgba(80,40,20,.35) 0 6px,
          rgba(120,70,40,.35) 6px 14px,
          rgba(60,30,15,.35) 14px 22px
        ),
        linear-gradient(180deg, #8c5d3d, #c08a5a 50%, #9a6946 100%);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.25), inset 0 -1px 0 rgba(0,0,0,.25);
      padding: 8px 12px;
      display: flex;
      align-items: center;
      justify-content: flex-start;
    }
    .engrave {
      font-weight: 400; letter-spacing: .18em; font-size: clamp(9px, 1.3vmin, 13px);
      color: rgba(0,0,0,.7);
      text-shadow: 0 1px 0 rgba(255,255,255,.25), 0 -1px 0 rgba(0,0,0,.8);
      text-transform: uppercase; text-align: left;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }

    .panel { display: grid; grid-template-rows: auto 1fr; height: 100%; width: 100%; background: linear-gradient(180deg, var(--bg2), var(--bg)); }

    .bar {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0));
    }

    .left-actions { justify-self: start; display: flex; gap: 8px; align-items: center; }
    .right-actions { justify-self: end; display: flex; gap: 8px; align-items: center; }

    .month-nav { justify-self: center; display: inline-flex; gap: 10px; align-items: center; }
    .month-title { font-weight: 800; letter-spacing: 0.06em; }

    .btn, .toggle {
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
      color: var(--text);
      border-radius: 999px;
      padding: 8px 12px;
      cursor: pointer;
      font-weight: 600;
    }

    .btn.icon { width: 36px; height: 32px; display:grid; place-items:center; padding:0; }

    .grid { display: grid; grid-template-rows: auto 1fr; height: 100%; min-height: 0; }
    .dow { display: grid; grid-template-columns: repeat(7, 1fr); text-align:center; padding: 6px 10px; color: var(--muted); }

    .days {
      --rows: 6;
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      grid-template-rows: repeat(var(--rows), 1fr);
      height: 100%;
      min-height: 0;
      gap: var(--tile);
      padding: 10px;
      box-sizing: border-box;
    }

    .day {
      position: relative; border-radius: 16px;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.045), rgba(255,255,255,.015));
      transition: transform .12s ease, box-shadow .12s ease, outline-color .12s ease;
      min-height: 0;
      overflow: hidden; /* keep the squares clipped cleanly */
    }

    .day:hover { transform: translateY(-2px); box-shadow: 0 8px 18px rgba(0,0,0,.35); }
    .num { position: absolute; top: 8px; right: 10px; font-size: .9rem; color: var(--muted); z-index: 2; }

    /* Habit grid container fills the card, leaving space for date number */
    .habit-grid {
      position: absolute;
      inset: var(--habit-top-reserve) var(--habit-pad) var(--habit-pad) var(--habit-pad);
      display: grid;
      grid-auto-flow: row dense;
      gap: var(--habit-gap);
      /* columns/rows are set dynamically by inline style via JS for best-fit squares */
    }
    .habit-square {
      width: var(--sq, 12px);
      height: var(--sq, 12px);
      border-radius: 4px;
      background: var(--accent);
      box-shadow: 0 1px 0 rgba(255,255,255,.12) inset, 0 1px 6px rgba(0,0,0,.25);
    }

    /* Today ring */
    .today {
      outline: 2px solid color-mix(in oklab, var(--accent) 60%, transparent);
      box-shadow: 0 0 0 3px color-mix(in oklab, var(--accent) 25%, transparent);
    }
    @supports not (color-mix(in oklab, white 50%, black)) {
      .today {
        outline: 2px solid var(--accent);
        box-shadow: 0 0 0 3px rgba(182,255,59,.25);
      }
    }

    /* Keyboard focus */
    .day:focus {
      outline: 2px solid rgba(255,255,255,.35);
      outline-offset: -2px;
      box-shadow: 0 0 0 3px rgba(255,255,255,.12);
    }

    @media (prefers-reduced-motion: reduce){ .day { transition: none; } }
    @media (max-width: 560px){ .dow { display: none; } .num { font-size: 0.85rem; } }
  </style>
</head>
<body>
  <div class="frame">
    <div class="top-wood">
      <div class="engrave">OPULENT&nbsp;HARDWARE</div>
    </div>

    <section class="panel">
      <header class="bar">
        <div class="left-actions"></div>
        <div class="month-nav">
          <button class="btn icon" id="prev" aria-label="Previous month">◀</button>
          <div class="month-title" id="title">—</div>
          <button class="btn icon" id="next" aria-label="Next month">▶</button>
        </div>
        <div class="right-actions">
          <button class="toggle" id="mode" aria-label="Toggle theme">Toggle</button>
        </div>
      </header>
      <div class="grid">
        <div class="dow" id="dow"></div>
        <div class="days" id="days" role="grid" aria-label="Calendar month grid"></div>
      </div>
    </section>
  </div>

  <script>
    /* ---- Params ---- */
    const params = new URLSearchParams(location.search);
    const themeParam = params.get('theme');
    const weekStart = Number(params.get('weekStart') ?? 0);
    const initial = params.get('initial');

    if (themeParam === 'light' || themeParam === 'dark') {
      document.documentElement.setAttribute('data-theme', themeParam);
    }

    /* ---- Elements ---- */
    const title = document.getElementById('title');
    const daysWrap = document.getElementById('days');
    const dowWrap = document.getElementById('dow');

    const WEEKDAYS = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

    function buildDOW() {
      const order = [...WEEKDAYS.slice(weekStart), ...WEEKDAYS.slice(0, weekStart)];
      dowWrap.innerHTML = order.map(d => `<div>${d}</div>`).join('');
    }

    let current = (() => {
      if (!initial) return new Date();
      const [y, m] = initial.split('-').map(Number);
      return new Date(y, (m || 1) - 1, 1);
    })();

    /* ---- App State ----
       events: (kept from v1 for future use)
       habits: map of "YYYY-MM-DD" -> integer count
    */
    const state = {
      events: {},
      habits: {}   // { "2025-10-22": 3, ... }
    };

    /* ---- Date helpers ---- */
    const fmtMonth = (date) => date.toLocaleDateString(undefined, { month: 'long', year: 'numeric' }).toUpperCase();
    const startOfMonth = (date) => new Date(date.getFullYear(), date.getMonth(), 1);
    const endOfMonth = (date) => new Date(date.getFullYear(), date.getMonth() + 1, 0);
    function keyFor(date){
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, '0');
      const d = String(date.getDate()).padStart(2, '0');
      return `${y}-${m}-${d}`;
    }

    /* ---- Habit grid sizing ----
       Given N squares and container size, choose cols/rows
       and compute a square size that fits (with gap).
    */
    function computeHabitLayout(n, w, h, gap) {
      if (n <= 0) return { cols: 0, rows: 0, size: 0 };
      // Reserve space already by CSS insets; w/h are the content box passed in
      let best = { size: 0, cols: 1, rows: n };
      // Try column counts around sqrt(n) for a near-square arrangement
      const s = Math.ceil(Math.sqrt(n));
      const candidates = new Set([1, 2, Math.max(1, s - 2), Math.max(1, s - 1), s, s + 1, s + 2, n]);
      for (const cols of candidates) {
        const rows = Math.ceil(n / cols);
        const sizeW = (w - (cols - 1) * gap) / cols;
        const sizeH = (h - (rows - 1) * gap) / rows;
        const size = Math.floor(Math.max(0, Math.min(sizeW, sizeH)));
        if (size > best.size) best = { size, cols, rows };
      }
      return best;
    }

    /* ---- Render ---- */
    function render() {
      buildDOW();
      const start = startOfMonth(current);
      const end = endOfMonth(current);
      title.textContent = fmtMonth(current);
      const startIdx = (start.getDay() - weekStart + 7) % 7;
      const daysInMonth = end.getDate();
      const today = new Date();

      const cells = startIdx + daysInMonth;
      const rows = Math.ceil(cells / 7);
      daysWrap.style.setProperty('--rows', rows);

      const frag = document.createDocumentFragment();

      // leading blanks (aria-hidden)
      for (let i = 0; i < startIdx; i++) {
        const blank = document.createElement('div');
        blank.setAttribute('aria-hidden', 'true');
        frag.appendChild(blank);
      }

      for (let d = 1; d <= daysInMonth; d++) {
        const date = new Date(current.getFullYear(), current.getMonth(), d);
        const isToday = date.toDateString() === today.toDateString();
        const key = keyFor(date);
        const evs = state.events[key] || [];
        const habitCount = state.habits[key] || 0;

        const cell = document.createElement('div');
        cell.className = `day ${isToday ? 'today' : ''}`;
        cell.dataset.date = key;
        cell.setAttribute('role', 'gridcell');
        cell.setAttribute('tabindex', '0');
        cell.setAttribute('aria-label', date.toLocaleDateString(undefined, {weekday:'long', year:'numeric', month:'long', day:'numeric'}));

        const num = document.createElement('div');
        num.className = 'num';
        num.textContent = d;
        cell.appendChild(num);

        // Optional: legacy event dots (kept for compatibility)
        if (evs.length) {
          const dots = document.createElement('div');
          dots.style.position = 'absolute';
          dots.style.left = '8px';
          dots.style.bottom = '6px';
          evs.slice(0, 3).forEach(() => {
            const dot = document.createElement('span');
            dot.style.display = 'inline-block';
            dot.style.width = dot.style.height = '6px';
            dot.style.marginRight = '4px';
            dot.style.borderRadius = '50%';
            dot.style.background = 'var(--accent)';
            dots.appendChild(dot);
          });
          if (evs.length > 3) {
            const more = document.createElement('span');
            more.textContent = `+${evs.length - 3}`;
            more.style.fontSize = '10px';
            more.style.color = 'var(--muted)';
            dots.appendChild(more);
          }
          cell.appendChild(dots);
        }

        // Habit grid container
        const grid = document.createElement('div');
        grid.className = 'habit-grid';
        grid.dataset.count = String(habitCount);
        cell.appendChild(grid);

        // Defer square rendering until cell is in DOM and sized
        frag.appendChild(cell);
      }

      daysWrap.innerHTML = '';
      daysWrap.appendChild(frag);

      // After mounting, size & render habit squares for each visible cell
      requestAnimationFrame(renderAllHabitSquares);
    }

    /* Renders squares for every .habit-grid based on its data-count and size */
    function renderAllHabitSquares() {
      const grids = daysWrap.querySelectorAll('.habit-grid');
      grids.forEach(grid => renderHabitSquaresInGrid(grid));
    }

    function renderHabitSquaresInGrid(gridEl) {
      const count = Number(gridEl.dataset.count || 0);
      gridEl.innerHTML = '';
      if (count <= 0) return;

      // Measure inner content box
      const rect = gridEl.getBoundingClientRect();
      const w = rect.width;
      const h = rect.height;
      const gap = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--habit-gap')) || 4;

      const layout = computeHabitLayout(count, w, h, gap);
      // Set CSS grid template for best-fit
      gridEl.style.gridTemplateColumns = `repeat(${layout.cols}, 1fr)`;
      gridEl.style.gridTemplateRows = `repeat(${layout.rows}, 1fr)`;
      gridEl.style.setProperty('--sq', `${Math.max(6, layout.size)}px`);

      // Create squares
      for (let i = 0; i < count; i++) {
        const sq = document.createElement('div');
        sq.className = 'habit-square';
        gridEl.appendChild(sq);
      }
    }

    /* ---- Interaction ----
       Click a day to increment its habit count for that date.
       (No delete yet—keeping V2 simple and intentional.)
    */
    daysWrap.addEventListener('click', (e) => {
      const dayEl = e.target.closest('.day');
      if (!dayEl || !daysWrap.contains(dayEl)) return;
      const key = dayEl.dataset.date;
      if (!key) return;
      state.habits[key] = (state.habits[key] || 0) + 1;

      // Update just this cell’s habit grid
      const grid = dayEl.querySelector('.habit-grid');
      if (grid) {
        grid.dataset.count = String(state.habits[key]);
        renderHabitSquaresInGrid(grid);
      }
    });

    /* Nav + theme toggle */
    document.getElementById('prev').onclick = () => {
      current = new Date(current.getFullYear(), current.getMonth() - 1, 1);
      render();
    };
    document.getElementById('next').onclick = () => {
      current = new Date(current.getFullYear(), current.getMonth() + 1, 1);
      render();
    };
    document.getElementById('mode').onclick = () => {
      const next = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', next);
      // Repaint squares to ensure any subtle size changes recalc cleanly
      requestAnimationFrame(renderAllHabitSquares);
    };

    /* Recompute on resize to keep squares snug */
    window.addEventListener('resize', () => requestAnimationFrame(renderAllHabitSquares));

    /* Initial paint */
    render();
  </script>
</body>
</html>
